<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EMEA PS - WorkItem Creator</title>
  <style>
    /* â”€â”€ Reset & tokens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --label-col : 220px;
      --radius    : 8px;
      --border    : #d0d7de;
      --accent    : #0061A8;
      --accent-hov: #004e8c;
      --bg        : #f6f8fa;
      --surface   : #ffffff;
      --text      : #1a1a2e;
      --muted     : #6e7781;
      --success   : #1a7f37;
      --error     : #cf222e;
      --warn-bg   : #fff8c5;
      --warn-border: #d4a72c;
    }

    body {
      font-family: system-ui, "Segoe UI", Arial, sans-serif;
      background : var(--bg);
      color      : var(--text);
      padding    : 24px 16px;
      min-height : 100vh;
    }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .container { max-width: 760px; margin: 0 auto; }

    h1 {
      font-size  : 1.5rem;
      font-weight: 700;
      margin-bottom: 24px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--accent);
      color: var(--accent);
    }

    /* â”€â”€ Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .card {
      background   : var(--surface);
      border       : 1px solid var(--border);
      border-radius: var(--radius);
      padding      : 24px;
      margin-bottom: 20px;
    }

    /* â”€â”€ Form grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .form-grid {
      display              : grid;
      grid-template-columns: var(--label-col) 1fr;
      gap                  : 14px 16px;
      align-items          : center;
    }

    .form-grid label {
      font-weight: 600;
      font-size  : 0.9rem;
    }



    /* â”€â”€ Button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn {
      display         : inline-block;
      padding         : 10px 22px;
      border          : none;
      border-radius   : var(--radius);
      font-size       : 0.95rem;
      font-weight     : 600;
      cursor          : pointer;
      transition      : background .2s, transform .1s;
    }
    .btn-primary {
      background: var(--accent);
      color     : #fff;
    }
    .btn-primary:hover  { background: var(--accent-hov); }
    .btn-primary:active { transform: scale(.98); }
    .btn-primary:disabled {
      background: #a0aec0;
      cursor    : not-allowed;
    }

    /* â”€â”€ Status / log panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #statusBanner {
      display      : none;
      padding      : 12px 16px;
      border-radius: var(--radius);
      font-size    : 0.875rem;
      margin-bottom: 16px;
      border       : 1px solid transparent;
    }
    #statusBanner.success {
      background  : #d4f5db;
      border-color: var(--success);
      color       : var(--success);
    }
    #statusBanner.error {
      background  : #ffdcdc;
      border-color: var(--error);
      color       : var(--error);
    }
    #statusBanner.info {
      background  : #daeeff;
      border-color: var(--accent);
      color       : var(--accent);
    }

    /* â”€â”€ Debug log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    details.debug-panel {
      margin-top: 24px;
      font-size : 0.8rem;
    }
    details.debug-panel summary {
      cursor     : pointer;
      font-weight: 600;
      color      : var(--muted);
      user-select: none;
      padding    : 4px 0;
    }
    #debugLog {
      margin-top    : 8px;
      background    : #1e1e2e;
      color         : #cdd6f4;
      border-radius : 6px;
      padding       : 12px;
      font-family   : "Cascadia Code", "Fira Code", monospace;
      font-size     : 0.78rem;
      max-height    : 320px;
      overflow-y    : auto;
      white-space   : pre-wrap;
      word-break    : break-all;
    }
    .log-info  { color: #89dceb; }
    .log-ok    { color: #a6e3a1; }
    .log-warn  { color: #f9e2af; }
    .log-error { color: #f38ba8; }

    /* â”€â”€ Auth overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #authOverlay {
      display        : flex;
      flex-direction : column;
      align-items    : center;
      justify-content: center;
      padding        : 40px;
      gap            : 16px;
      text-align     : center;
    }
    #authOverlay p { color: var(--muted); }

    /* â”€â”€ Spinner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .spinner {
      display     : inline-block;
      width       : 20px;
      height      : 20px;
      border      : 3px solid rgba(0,97,168,.3);
      border-top  : 3px solid var(--accent);
      border-radius: 50%;
      animation   : spin .7s linear infinite;
      vertical-align: middle;
      margin-right: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ Divider â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section-divider {
      border     : none;
      border-top : 1px solid var(--border);
      margin     : 20px 0;
    }
  </style>
</head>
<body>
<div class="container">

  <h1>EMEA PS â€” WorkItem Creator</h1>

  <!-- Status banner -->
  <div id="statusBanner" role="alert"></div>

  <!-- Main card: shown after auth -->
  <div class="card" id="mainCard" style="display:none">

    <!-- Work type selector -->
    <div class="form-grid" style="margin-bottom:20px">
      <label for="workTypeSelect">Select Work Type:</label>
      <select id="workTypeSelect">
        <option value="">â€” Select a Work Type â€”</option>
      </select>
    </div>

    <hr class="section-divider">

    <!-- Dynamic attribute form -->
    <form id="workItemForm" novalidate>
      <div id="attributesContainer"></div>

      <div style="margin-top:8px">
        <button type="submit" id="submitBtn" class="btn btn-primary" disabled>
          Create Work Item
        </button>
      </div>
    </form>

  </div>

  <!-- Auth overlay: shown before auth -->
  <div class="card" id="authCard">
    <div id="authOverlay">
      <div class="spinner"></div>
      <p id="authMessage">Checking authenticationâ€¦</p>
    </div>
  </div>

  <!-- Debug log (collapsed by default) -->
  <details class="debug-panel" open>
    <summary>ğŸ›  Debug Log</summary>
    <div id="debugLog"></div>
  </details>

</div>

<script>
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CONFIG  â€” edit these values only
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const CLIENT_ID    = '584c1e79-568e-4d71-91ff-3e00bf01d04b';
  const REGION       = 'euw2.pure.cloud';
  const API_BASE     = `https://api.${REGION}`;
  const AUTH_BASE    = `https://login.${REGION}`;
  // REDIRECT_URI is derived at runtime so it works on any host
  const REDIRECT_URI = window.location.origin + window.location.pathname;

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DEBUG LOGGER
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  const logEl = document.getElementById('debugLog');

  function log(msg, level = 'info') {
    const ts   = new Date().toISOString().slice(11, 23);
    const line = document.createElement('div');
    line.className = `log-${level}`;
    line.textContent = `[${ts}] ${msg}`;
    logEl.appendChild(line);
    logEl.scrollTop = logEl.scrollHeight;
    console[level === 'error' ? 'error' : level === 'warn' ? 'warn' : 'log'](msg);
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STATUS BANNER
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  function showStatus(msg, type = 'info') {
    const el  = document.getElementById('statusBanner');
    el.textContent  = msg;
    el.className    = type;
    el.style.display = 'block';
    if (type === 'success') setTimeout(() => { el.style.display = 'none'; }, 6000);
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PKCE HELPERS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  /** Generate a cryptographically random code verifier (43-128 chars) */
  function generateCodeVerifier() {
    const arr = new Uint8Array(64);
    crypto.getRandomValues(arr);
    return btoa(String.fromCharCode(...arr))
      .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
  }

  /** Derive code_challenge = BASE64URL(SHA-256(verifier)) */
  async function generateCodeChallenge(verifier) {
    const encoder = new TextEncoder();
    const data    = encoder.encode(verifier);
    const digest  = await crypto.subtle.digest('SHA-256', data);
    return btoa(String.fromCharCode(...new Uint8Array(digest)))
      .replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');
  }

  /** Kick off the PKCE authorisation redirect */
  async function redirectToGenesysOAuth() {
    const verifier   = generateCodeVerifier();
    const challenge  = await generateCodeChallenge(verifier);

    // Persist verifier so we can use it after the redirect
    sessionStorage.setItem('pkce_verifier', verifier);

    const params = new URLSearchParams({
      response_type          : 'code',
      client_id              : CLIENT_ID,
      redirect_uri           : REDIRECT_URI,
      code_challenge         : challenge,
      code_challenge_method  : 'S256',
    });

    const authUrl = `${AUTH_BASE}/oauth/authorize?${params}`;
    log(`Redirecting to Genesys PKCE auth: ${authUrl}`, 'info');
    window.location.href = authUrl;
  }

  /** Exchange the auth code for an access token */
  async function exchangeCodeForToken(code) {
    const verifier = sessionStorage.getItem('pkce_verifier');
    if (!verifier) {
      throw new Error('PKCE verifier missing from sessionStorage â€” cannot exchange code.');
    }

    log('Exchanging authorisation code for access tokenâ€¦', 'info');

    const body = new URLSearchParams({
      grant_type    : 'authorization_code',
      client_id     : CLIENT_ID,
      code          : code,
      redirect_uri  : REDIRECT_URI,
      code_verifier : verifier,
    });

    const response = await fetch(`${AUTH_BASE}/oauth/token`, {
      method : 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body,
    });

    const data = await response.json();

    if (!response.ok) {
      log(`Token exchange failed (${response.status}): ${JSON.stringify(data)}`, 'error');
      throw new Error(data.error_description || 'Token exchange failed');
    }

    sessionStorage.removeItem('pkce_verifier'); // clean up
    log('Access token obtained successfully.', 'ok');
    return data.access_token;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     GENESYS API HELPERS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  let accessToken = '';

  /** Thin fetch wrapper that handles auth errors and logs responses */
  async function apiFetch(path, options = {}) {
    const url = path.startsWith('http') ? path : `${API_BASE}${path}`;
    log(`â†’ ${options.method || 'GET'} ${url}`, 'info');

    const response = await fetch(url, {
      ...options,
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'Accept'       : 'application/json',
        'Content-Type' : 'application/json',
        ...(options.headers || {}),
      },
    });

    const text = await response.text();
    let data;
    try { data = JSON.parse(text); } catch { data = text; }

    if (!response.ok) {
      log(`â† ${response.status} ${response.statusText} | ${JSON.stringify(data)}`, 'error');
      throw new Error(`API ${response.status}: ${response.statusText}`);
    }

    log(`â† ${response.status} OK`, 'ok');
    return data;
  }

  /* â”€â”€ Work Types â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function fetchWorkTypes() {
    log('Fetching work types (filter: name BEGINS_WITH "CD")â€¦', 'info');
    const data = await apiFetch('/api/v2/taskmanagement/worktypes/query', {
      method: 'POST',
      body  : JSON.stringify({
        pageSize  : 30,
        attributes: ['id', 'name', 'schemaId'],  // schemaId is the correct flat attribute name
        filters   : [{ name: 'name', type: 'string', operator: 'BEGINS_WITH', values: ['CD'] }],
      }),
    });

    const entities = data.entities || [];
    log(`Received ${entities.length} work type(s).`, entities.length ? 'ok' : 'warn');
    return entities;
  }

  /* â”€â”€ Schema â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function fetchSchema(schemaId) {
    log(`Fetching schema id=${schemaId}â€¦`, 'info');
    const data = await apiFetch(`/api/v2/taskmanagement/workitems/schemas/${schemaId}`);
    // Log the full response so we can see exactly what was returned
    log(`Schema raw response: ${JSON.stringify(data)}`, 'info');
    // The schema can live at different depths depending on API version
    const props = data?.jsonSchema?.properties
                ?? data?.properties
                ?? null;
    if (!props) {
      log('WARNING: Could not find .properties in schema response â€” check raw log above.', 'warn');
    } else {
      log(`Schema has ${Object.keys(props).length} properties: ${Object.keys(props).join(', ')}`, 'ok');
    }
    return { ...data, _resolvedProperties: props };
  }

  /* â”€â”€ Create Work Item â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  async function createWorkItem(workTypeId, formAttributes) {
    // Separate the core "name" field from custom fields
    const customFields = {};
    Object.entries(formAttributes).forEach(([key, value]) => {
      if (key === 'name' || value === '') return;
      customFields[key] = key.endsWith('_checkbox') ? value === 'on' : value;
    });

    const payload = {
      typeId      : workTypeId,
      name        : formAttributes.name,
      customFields,
    };

    log(`Creating work item: ${JSON.stringify(payload)}`, 'info');
    return await apiFetch('/api/v2/taskmanagement/workitems', {
      method: 'POST',
      body  : JSON.stringify(payload),
    });
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     UI HELPERS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  function populateDropdown(workTypes) {
    const sel = document.getElementById('workTypeSelect');
    workTypes.forEach(wt => {
      const opt       = document.createElement('option');
      opt.value       = wt.id;
      opt.textContent = wt.name;
      // schemaId comes back as a flat string from the query API
      opt.dataset.schemaId = wt.schemaId ?? '';
      log(`  Work type: "${wt.name}" id=${wt.id} schemaId=${opt.dataset.schemaId}`, 'info');
      sel.appendChild(opt);
    });
    log('Work type dropdown populated.', 'ok');
  }

  function renderSchemaAttributes(properties) {
    const container = document.getElementById('attributesContainer');
    container.innerHTML = '';

    const keys = Object.keys(properties).filter(k => !k.startsWith('z_routing'));
    log(`Rendering ${keys.length} schema attribute(s): ${keys.join(', ')}`, 'ok');

    /* â”€â”€ Workitem Name (always first) â”€â”€ */
    container.appendChild(buildTextRow('name', 'Workitem Name', true));

    /* â”€â”€ Dynamic schema fields â”€â”€ */
    keys.forEach(key => {
      const attr = properties[key];
      if (key.endsWith('_enum')) {
        container.appendChild(buildSelectRow(key, attr));
      } else if (key.endsWith('_checkbox')) {
        container.appendChild(buildCheckboxRow(key, attr));
      } else if (key.endsWith('_datetime')) {
        container.appendChild(buildDateTimeRow(key, attr));
      } else {
        container.appendChild(buildTextRow(key, attr.title || key));
      }
    });

    if (keys.length === 0) {
      log('Schema had no custom properties after filtering z_routing fields.', 'warn');
      const note = document.createElement('p');
      note.style.cssText = 'color:var(--muted); font-size:0.85rem; margin-bottom:14px;';
      note.textContent   = 'No custom attributes defined for this work type schema.';
      container.appendChild(note);
    }

    document.getElementById('submitBtn').disabled = false;
  }

  /* â”€â”€ Row builders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

  function buildTextRow(id, labelText, required = false) {
    const row   = makeRow();
    const label = makeLabel(id, labelText);
    const input = document.createElement('input');
    input.type      = 'text';
    input.id        = id;
    input.name      = id;
    input.required  = required;
    input.style.cssText = 'width:100%; padding:9px 10px; border:1px solid var(--border); border-radius:6px; font-size:0.9rem;';
    row.appendChild(label);
    row.appendChild(input);
    return row;
  }

  function buildSelectRow(id, attr) {
    const row   = makeRow();
    const label = makeLabel(id, attr.title);
    const sel   = document.createElement('select');
    sel.id       = id;
    sel.name     = id;
    sel.required = true;
    sel.style.cssText = 'width:100%; padding:9px 10px; border:1px solid var(--border); border-radius:6px; font-size:0.9rem;';
    sel.innerHTML = '<option value="">Selectâ€¦</option>';
    (attr.enum || []).forEach(v => {
      const opt       = document.createElement('option');
      opt.value       = v;
      opt.textContent = v;
      sel.appendChild(opt);
    });
    row.appendChild(label);
    row.appendChild(sel);
    return row;
  }

  function buildCheckboxRow(id, attr) {
    const row   = document.createElement('div');
    row.style.cssText = 'display:flex; align-items:center; gap:10px; margin-bottom:14px; font-weight:600; font-size:0.9rem;';
    const input = document.createElement('input');
    input.type  = 'checkbox';
    input.id    = id;
    input.name  = id;
    input.style.cssText = 'width:18px; height:18px; cursor:pointer; flex-shrink:0;';
    const label = document.createElement('label');
    label.setAttribute('for', id);
    label.textContent = attr.title;
    row.appendChild(input);
    row.appendChild(label);
    return row;
  }

  function buildDateTimeRow(id, attr) {
    const row   = makeRow();
    const label = makeLabel(id, attr.title);
    const input = document.createElement('input');
    input.type  = 'datetime-local';
    input.id    = id;
    input.name  = id;
    input.style.cssText = 'width:100%; padding:9px 10px; border:1px solid var(--border); border-radius:6px; font-size:0.9rem;';
    row.appendChild(label);
    row.appendChild(input);
    return row;
  }

  function makeRow() {
    const d = document.createElement('div');
    // Each row is its own two-column grid: label | input
    d.style.cssText = 'display:grid; grid-template-columns:var(--label-col) 1fr; gap:0 16px; align-items:center; margin-bottom:14px;';
    return d;
  }

  function makeLabel(forId, text) {
    const l = document.createElement('label');
    l.setAttribute('for', forId);
    l.textContent = text;
    return l;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     EVENT WIRING
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

  // Work type change â†’ fetch schema â†’ render fields
  document.getElementById('workTypeSelect').addEventListener('change', async e => {
    const selectedOpt = e.target.selectedOptions[0];
    const schemaId    = selectedOpt?.dataset?.schemaId;
    const container   = document.getElementById('attributesContainer');
    const submitBtn   = document.getElementById('submitBtn');

    container.innerHTML = '';
    submitBtn.disabled  = true;

    if (!schemaId) {
      log('No schemaId on selected option â€” cannot load attributes.', 'warn');
      return;
    }

    // Show a loading indicator inside the form area
    container.innerHTML = '<div style="padding:12px;color:var(--muted)"><span class="spinner"></span> Loading schema attributesâ€¦</div>';

    try {
      const schema     = await fetchSchema(schemaId);
      const properties = schema._resolvedProperties || {};
      renderSchemaAttributes(properties);
    } catch (err) {
      container.innerHTML = '';
      log(`Failed to fetch schema: ${err.message}`, 'error');
      showStatus(`Could not load schema: ${err.message}`, 'error');
    }
  });

  // Form submit â†’ create work item
  document.getElementById('workItemForm').addEventListener('submit', async e => {
    e.preventDefault();

    const workTypeId = document.getElementById('workTypeSelect').value;
    if (!workTypeId) {
      showStatus('Please select a Work Type.', 'error');
      return;
    }

    const btn        = document.getElementById('submitBtn');
    btn.disabled     = true;
    btn.innerHTML    = '<span class="spinner"></span>Creatingâ€¦';

    const formData   = new FormData(e.target);
    const attributes = Object.fromEntries(formData.entries());

    try {
      const result = await createWorkItem(workTypeId, attributes);
      log(`Work item created: id=${result.id} name="${result.name}"`, 'ok');
      showStatus(`âœ“ Work Item "${result.name}" created (id: ${result.id})`, 'success');
      e.target.reset();
      document.getElementById('attributesContainer').innerHTML = '';
      document.getElementById('workTypeSelect').value = '';
    } catch (err) {
      log(`Work item creation failed: ${err.message}`, 'error');
      showStatus(`Failed to create Work Item: ${err.message}`, 'error');
    } finally {
      btn.disabled  = false;
      btn.innerHTML = 'Create Work Item';
    }
  });

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     INIT
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  async function init() {
    log('App initialisingâ€¦', 'info');
    log(`Redirect URI: ${REDIRECT_URI}`, 'info');

    const urlParams = new URLSearchParams(window.location.search);
    const code      = urlParams.get('code');
    const authError = urlParams.get('error');

    /* â”€â”€ Auth error returned from Genesys â”€â”€ */
    if (authError) {
      const desc = urlParams.get('error_description') || authError;
      log(`OAuth error from Genesys: ${desc}`, 'error');
      showStatus(`Authentication error: ${desc}`, 'error');
      document.getElementById('authMessage').textContent = `Auth error: ${desc}`;
      return;
    }

    /* â”€â”€ PKCE code returned â€” exchange for token â”€â”€ */
    if (code) {
      // Strip the code from the URL bar (cosmetic, also prevents accidental re-use)
      const cleanUrl = window.location.origin + window.location.pathname;
      window.history.replaceState({}, document.title, cleanUrl);

      try {
        accessToken = await exchangeCodeForToken(code);
        sessionStorage.setItem('gc_access_token', accessToken); // optional: cache token
        showStatus('Authenticated successfully.', 'success');
      } catch (err) {
        log(`Token exchange error: ${err.message}`, 'error');
        showStatus(`Authentication failed: ${err.message}`, 'error');
        document.getElementById('authMessage').textContent = `Auth failed: ${err.message}`;
        return;
      }
    } else {
      /* â”€â”€ Check for a previously cached token â”€â”€ */
      const cached = sessionStorage.getItem('gc_access_token');
      if (cached) {
        log('Reusing cached access token from sessionStorage.', 'info');
        accessToken = cached;
      } else {
        /* â”€â”€ No token at all â€” kick off PKCE flow â”€â”€ */
        log('No token found â€” starting PKCE authorisation flow.', 'info');
        document.getElementById('authMessage').textContent = 'Redirecting to Genesys loginâ€¦';
        await redirectToGenesysOAuth();
        return; // page will redirect
      }
    }

    /* â”€â”€ Authenticated: show main UI â”€â”€ */
    document.getElementById('authCard').style.display = 'none';
    document.getElementById('mainCard').style.display = 'block';
    showStatus('Loading work typesâ€¦', 'info');

    try {
      const workTypes = await fetchWorkTypes();
      if (workTypes.length === 0) {
        showStatus('No work types found matching the "CD" prefix.', 'warn');
        log('No work types returned. Check filter or permissions.', 'warn');
        return;
      }
      populateDropdown(workTypes);
      showStatus(`${workTypes.length} work type(s) loaded. Select one to begin.`, 'info');
    } catch (err) {
      log(`Failed to load work types: ${err.message}`, 'error');
      showStatus(`Could not load work types: ${err.message}`, 'error');

      // If we get a 401, the token may be stale â€” clear it and re-auth
      if (err.message.includes('401')) {
        log('401 received â€” clearing cached token and re-authenticating.', 'warn');
        sessionStorage.removeItem('gc_access_token');
        await redirectToGenesysOAuth();
      }
    }
  }

  init();
</script>
</body>
</html>
